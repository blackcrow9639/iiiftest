<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Mirador ドラッグ&ドロップでマニフェスト読み込み</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; margin: 0; }
    #dropzone {
      border: 2px dashed #bbb;
      border-radius: 8px;
      padding: 18px;
      margin: 12px;
      text-align: center;
      color: #555;
      transition: background .12s, border-color .12s;
    }
    #dropzone.dragover { background: #f0f8ff; border-color: #3b82f6; color: #0b3d91; }
    #viewer { height: calc(100vh - 120px); margin: 12px; }
    .hint { font-size: 0.9rem; color: #666; margin-top: 8px; }
  </style>
  <!-- Mirador CDN -->
  <script src="https://unpkg.com/mirador@latest/dist/mirador.min.js"></script>
</head>
<body>
  <div id="dropzone">
    マニフェスト（IIIF）URLをここにドラッグ＆ドロップしてください。<br>
    または URL を貼り付けて Enter キーで読み込みできます。
    <div class="hint">例: https://example.org/iiif/manifest.json</div>
    <input id="urlInput" type="text" placeholder="マニフェストのURLをここに貼り付け" style="width:70%; margin-top:8px; padding:6px;">
  </div>

  <div id="viewer"></div>

  <script>
    // 初期空ビューア（何も表示しない状態）
    function initEmptyViewer() {
      // clear container then init Mirador with no windows
      document.getElementById('viewer').innerHTML = '';
      Mirador.viewer({
        id: 'viewer',
        windows: []
      });
    }

    // シンプルなURLバリデータ
    function isLikelyUrl(s) {
      try {
        const u = new URL(s);
        return u.protocol === 'http:' || u.protocol === 'https:';
      } catch (e) {
        return false;
      }
    }

    // マニフェストを読み込む（ここでは viewer を再初期化して windows に manifest を渡す方法）
    function loadManifest(manifestUrl) {
      if (!isLikelyUrl(manifestUrl)) {
        alert('有効な URL を指定してください: ' + manifestUrl);
        return;
      }

      // 既存のビューアをクリアして再生成（簡単で確実な方法）
      document.getElementById('viewer').innerHTML = '';

      Mirador.viewer({
        id: 'viewer',
        windows: [
          {
            // Mirador のバージョンによってキー名が manifestId / loadedManifest / content が差分あり得るが、
            // 一般的な usage: manifestId に IIIF manifest の URL を入れる
            manifestId: manifestUrl,
            // 追加オプションがあればここに
          }
        ]
      });
    }

    // ドロップ処理
    const dz = document.getElementById('dropzone');

    dz.addEventListener('dragover', (ev) => {
      ev.preventDefault(); // 必須：drop を受け付ける
      dz.classList.add('dragover');
    });

    dz.addEventListener('dragleave', (ev) => {
      dz.classList.remove('dragover');
    });

    dz.addEventListener('drop', async (ev) => {
      ev.preventDefault();
      dz.classList.remove('dragover');

      const dt = ev.dataTransfer;

      // 優先順： text/uri-list -> text/plain -> items (リンク要素) -> ファイル（もし manifest.json を直接ドロップしたら FileReader で読み込める）
      let url = '';

      // text/uri-list はブラウザ間で差あり
      url = dt.getData('text/uri-list') || dt.getData('text/plain');

      // もしリンク要素がドロップされた場合 (a.href)
      if (!url && dt.items) {
        for (const item of dt.items) {
          if (item.kind === 'string') {
            // 文字列取得をプロミスでラップ
            url = await new Promise(resolve => item.getAsString(s => resolve(s)));
            if (url) break;
          } else if (item.kind === 'file') {
            const file = item.getAsFile();
            // manifest.json ファイルを直接ドロップした場合は、一旦ローカルのデータを object URL にして読み込める
            if (file && file.name.toLowerCase().endsWith('.json')) {
              const objectUrl = URL.createObjectURL(file);
              loadManifest(objectUrl);
              return;
            }
          }
        }
      }

      // 最後に簡易的に href を抜く（HTML要素がドロップされたとき）
      if (!url && ev.target) {
        // nothing
      }

      if (url) {
        // 先頭の改行などを取り除く
        url = url.trim().split('\n')[0];
        loadManifest(url);
      } else {
        alert('ドロップされた内容から有効な URL が見つかりませんでした。URL を直接貼り付けるか、manifest.json ファイルをドロップしてください。');
      }
    });

    // テキスト入力から読み込み
    const input = document.getElementById('urlInput');
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const v = input.value.trim();
        if (v) loadManifest(v);
      }
    });

    // 初期状態
    initEmptyViewer();
  </script>
</body>
</html>
